<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>Using Traefik and authelia to protect your services</title>
	<meta name="description" content="Described with asciidoc, built with Hugo and hosted on Github.">
	<meta name="author" content="Timothé &#34;NokiDev&#34; Van Deputte">
	<link rel="stylesheet"
      href="/css/tomorrow-night-bright.min.css">
	<script src="/js/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	<link rel="stylesheet" href="/css/style.css">
	
</head>
<body>
	<header>
	(╯°□°)╯︵ uozɐɯɐ - (╯°□°)╯︵ ʞooqǝɔɐɟ  - (╯°□°)╯︵ ǝlddɐ - (╯°□°)╯︵ ǝlƃoooƃ <br>
	/***********************************************************************************************<br>
	*
	\name <a href="https://blog-gh.noki.fr">NokiDev&#39;s blog</a><br>
	*
	\author Timothé &#34;NokiDev&#34; Van Deputte<br>
	*
	\brief <span>A Tech blog about infrastructure and development</span><br>
	*
	\details <span>Described with asciidoc, built with Hugo and hosted on Github.</span><br>
	*
	\note Source repository is <a href="https://github.com/NokiDev/blog">there</a>
	<br>*
	If you find any inconsistencies or want to talk please submit an issue :)
	<br>
	***********************************************************************************************/
	<p>
	<nav>
			
			
			<a href="/about/"><b>About</b></a>.
			
			<a href="/"><b>Latest</b></a>.
			
			<a href="/posts/"><b>All posts</b></a>.
			
			<a href="/categories/"><b>Categories</b></a>.
			
			<a href="/tags/"><b>Tags</b></a>.
			
	</nav>
	</p>
	
</header>

	
	<main>
		<article>
			<h1>Using Traefik and authelia to protect your services</h1>
			<b><time>12.06.2020 20:30</time></b>
		       
			<div>
				<div class="paragraph">
<p><a href="https://github.com/authelia/authelia">Authelia</a> is a great service, to help to protect your other services.
I choose it because it has some nice features such as LDAP integration, TOTP, Yubikey and push notification support, it has been initiated by a french developper, and is written in go. (The last point is totally subjective but Go software tends to be good softwares.)</p>
</div>
<div class="paragraph">
<p>I deployed it on my homelab for protecting services that doesn&#8217;t provide any authentication, such as traefik dashboard or for services that don&#8217;t provide ldap auth.
In this article we&#8217;ll see how authelia integrates with traefik and can be used to protect traefik dashboard.
This article is part of my traefik setup series I wrote on this blog, if you are unaware and want to take a look, please go for it.</p>
</div>
<div class="sect1">
<h2 id="_setup_authelia">Setup authelia</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">###############################################################
#                   Authelia configuration                    #
###############################################################

# The port to listen on
host: 0.0.0.0
port: 9091

# Log level
#
# Level of verbosity for logs
logs_level: debug

# The secret used to generate JWT tokens when validating user identity by
# email confirmation.
jwt_secret: SECRET_HERE

# Default redirection URL
#
# If user tries to authenticate without any referer, Authelia
# does not know where to redirect the user to at the end of the
# authentication process.
# This parameter allows you to specify the default redirection
# URL Authelia will use in such a case.
#
# Note: this parameter is optional. If not provided, user won't
# be redirected upon successful authentication.
default_redirection_url: https://auth.domain.tld/

# TOTP Issuer Name
#
# This will be the issuer name displayed in Google Authenticator
# See: https://github.com/google/google-authenticator/wiki/Key-Uri-Format for more info on issuer names
totp:
  issuer: auth.domain.tld

# Duo Push API
#
# Parameters used to contact the Duo API. Those are generated when you protect an application
# of type "Partner Auth API" in the management panel.
#duo_api:
#  hostname: api-123456789.example.com
#  integration_key: ABCDEF
#  secret_key: 1234567890abcdefghifjkl

# The authentication backend to use for verifying user passwords
# and retrieve information such as email address and groups
# users belong to.
#
# There are two supported backends: `ldap` and `file`.
authentication_backend:
  # LDAP backend configuration.
  #
  # This backend allows Authelia to be scaled to more
  # than one instance and therefore is recommended for
  # production.
  #ldap:
    # The url of the ldap server
    #url: ldap://openldap

    #skip_verify: false
    # The base dn for every entries
    #base_dn: dc=domain,dc=local

    # An additional dn to define the scope to all users
    #additional_users_dn: ou=users

    # The users filter used to find the user DN
    # {0} is a matcher replaced by username.
    # 'cn={0}' by default.
    #users_filter: (uid={0})

    # An additional dn to define the scope of groups
    #additional_groups_dn: ou=groups

    # The groups filter used for retrieving groups of a given user.
    # {0} is a matcher replaced by username.
    # {dn} is a matcher replaced by user DN.
    # {uid} is a matcher replaced by user uid.
    # 'member={dn}' by default.
    #groups_filter: (&amp;(member={dn})(objectclass=groupOfNames))

    # The attribute holding the name of the group
    #group_name_attribute: cn

    # The attribute holding the mail address of the user
    #mail_attribute: mail

    # The username and password of the admin user.
    #user: admin
    #password: admin

  # File backend configuration.
  #
  # With this backend, the users database is stored in a file
  # which is updated when users reset their passwords.
  # Therefore, this backend is meant to be used in a dev environment
  # and not in production since it prevents Authelia to be scaled to
  # more than one instance.
  #
  file:
    path: ./users_database.yml


# Access Control
#
# Access control is a list of rules defining the authorizations applied for one
# resource to users or group of users.
#
# If 'access_control' is not defined, ACL rules are disabled and the `bypass`
# rule is applied, i.e., access is allowed to anyone. Otherwise restrictions follow
# the rules defined.
#
# Note: One can use the wildcard * to match any subdomain.
# It must stand at the beginning of the pattern. (example: *.mydomain.com)
#
# Note: You must put patterns containing wildcards between simple quotes for the YAML
# to be syntaxically correct.
#
# Definition: A `rule` is an object with the following keys: `domain`, `subject`,
# `policy` and `resources`.
#
# - `domain` defines which domain or set of domains the rule applies to.
#
# - `subject` defines the subject to apply authorizations to. This parameter is
#    optional and matching any user if not provided. If provided, the parameter
#    represents either a user or a group. It should be of the form 'user:&lt;username&gt;'
#    or 'group:&lt;groupname&gt;'.
#
# - `policy` is the policy to apply to resources. It must be either `bypass`,
#   `one_factor`, `two_factor` or `deny`.
#
# - `resources` is a list of regular expressions that matches a set of resources to
#    apply the policy to. This parameter is optional and matches any resource if not
#    provided.
#
# Note: the order of the rules is important. The first policy matching
# (domain, resource, subject) applies.
access_control:
  # Default policy can either be `bypass`, `one_factor`, `two_factor` or `deny`.
  # It is the policy applied to any resource if there is no policy to be applied
  # to the user.
  default_policy: one_factor

  rules:
    - domain: auth.domain.tld
      policy: bypass

# Configuration of session cookies
#
# The session cookies identify the user once logged in.
session:
  # The name of the session cookie. (default: authelia_session).
  name: authelia_session

  # The secret to encrypt the session cookie.
  secret: 3EG3CuG6LSHfSdHWCu5scchTgK7adjjA8MmhM7cXbspQyqm5eQgnZG

  # The time in ms before the cookie expires and session is reset.
  expiration: 3600000 # 1 hour

  # The inactivity time in ms before the session is reset.
  inactivity: 300000 # 5 minutes

  # The domain to protect.
  # Note: the authenticator must also be in that domain. If empty, the cookie
  # is restricted to the subdomain of the issuer.
  domain: home.noki.fr

  # The redis connection details
  redis:
    host: redis
    port: 6379
#    password: authelia

# Configuration of the authentication regulation mechanism.
#
# This mechanism prevents attackers from brute forcing the first factor.
# It bans the user if too many attempts are done in a short period of
# time.
regulation:
  # The number of failed login attempts before user is banned.
  # Set it to 0 to disable regulation.
  max_retries: 3

  # The time range during which the user can attempt login before being banned.
  # The user is banned if the authentication failed `max_retries` times in a `find_time` seconds window.
  find_time: 120

  # The length of time before a banned user can login again.
  ban_time: 300

# Configuration of the storage backend used to store data and secrets.
#
# You must use only an available configuration: local, sql
storage:
  # The directory where the DB files will be saved
  local:
    path: /var/lib/authelia/db.sqlite3

  # Settings to connect to MySQL server
  #mysql:
  #  host: 127.0.0.1
  #  port: 3306
  #  database: authelia
  #  username: authelia
  #  password: mypassword

  # Settings to connect to MySQL server
  # postgres:
  #   host: 127.0.0.1
  #   port: 3306
  #   database: authelia
  #   username: authelia
  #   password: mypassword

# Configuration of the notification system.
#
# Notifications are sent to users when they require a password reset, a u2f
# registration or a TOTP registration.
# Use only an available configuration: filesystem, gmail
notifier:
  # For testing purpose, notifications can be sent in a file
  ## filesystem:
  ##   filename: /tmp/authelia/notification.txt

  # Use a SMTP server for sending notifications. Authelia uses PLAIN method to authenticate.
  # [Security] Make sure the connection is made over TLS otherwise your password will transit in plain text.
  smtp:
    username: test
    password: password
    host: 127.0.0.1
    port: 1025
    sender: admin@example.com

  # Sending an email using a Gmail account is as simple as the next section.
  # You need to create an app password by following: https://support.google.com/accounts/answer/185833?hl=en
  ## smtp:
  ##   username: myaccount@gmail.com
  ##   password: yourapppassword
  ##   sender: admin@example.com
  ##   host: smtp.gmail.com
  ##   port: 587</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">version: '3.7'

networks:
  proxy:
    external: true
  session_db:

services:
  redis:
    image: redis:5.0.7-alpine
    networks:
      - session_db

  authelia:
    image: authelia/authelia:4.2.0
    container_name: authelia
    restart: unless-stopped
    depends_on:
      - redis
    environment:
      - TZ=Europe/Paris
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./authelia_config.yml:/etc/authelia/configuration.yml
    networks:
      - proxy
      - session_db
    labels:
      traefik.enable: true
      traefik.http.routers.auth.entrypoints: web, web-secure
      traefik.http.services.auth.loadbalancer.server.port: 9091
      traefik.http.services.auth.loadbalancer.server.scheme: http</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup_traefiks_forwardauth_middelware">Setup traefik&#8217;s forwardAuth middelware</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_protecting_traefiks_dashboard">Protecting traefik&#8217;s dashboard</h2>
<div class="sectionbody">

</div>
</div>

			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/traefik_article_series/02_securing_traefik_installation/">Securing traefik installation</a></li>
				
				<li><a href="/posts/traefik_article_series/03_using_traefik_and_authelia_to_secure_services_access/">Using Traefik and authelia to protect your services</a></li>
				
				<li><a href="/posts/traefik_article_series/01_using_traefik_2.2_reverse_proxy_for_selfhosting/">Using Traefik v2.2 to selfhost your first service.</a></li>
				
				<li><a href="/posts/orange_dns_and_accessing_external_services/">Orange DNS and accessing services on local network with Domain name</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<span>====================================================================================================</span>
	<p>&copy; 2020 <a href="https://blog-gh.noki.fr"><b>NokiDev&#39;s blog</b></a>.
	<a href="https://github.com/NokiDev"><b>Github</b></a>.
	<a href="https://gitlab.com/NokiDev"><b>Gitlab</b></a>.
	<a href="https://twitter.com/NokiDev"><b>Twitter</b></a>.
	</p>
	<span>====================================================================================================</span>
</footer>

</body>
</html>
